<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BugSpotter Demo - Test All Capture Features</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        padding: 2rem;
        background: #f5f7fa;
        min-height: 100vh;
        color: #1a202c;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #1a365d;
        color: white;
        padding: 2rem;
        border-bottom: 1px solid #2c5282;
      }

      .header h1 {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .header p {
        font-size: 1rem;
        color: #e2e8f0;
        font-weight: 400;
      }

      .content {
        padding: 2rem;
      }

      .section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f7fafc;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
      }

      .section h2 {
        color: #2d3748;
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .section p {
        color: #4a5568;
        margin-bottom: 1rem;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .button-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
      }

      button {
        padding: 0.625rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      button:hover {
        opacity: 0.95;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      button:active {
        opacity: 1;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #2c5282;
        color: white;
      }

      .btn-primary:hover {
        background: #2a4365;
      }

      .btn-success {
        background: #2f855a;
        color: white;
      }

      .btn-success:hover {
        background: #276749;
      }

      .btn-warning {
        background: #c05621;
        color: white;
      }

      .btn-warning:hover {
        background: #9c4221;
      }

      .btn-danger {
        background: #c53030;
        color: white;
      }

      .btn-danger:hover {
        background: #9b2c2c;
      }

      .btn-info {
        background: #2b6cb0;
        color: white;
      }

      .btn-info:hover {
        background: #2c5282;
      }

      .btn-capture {
        grid-column: 1 / -1;
        background: #1a365d;
        color: white;
        font-size: 1rem;
        padding: 1rem;
        font-weight: 500;
        letter-spacing: 0.025em;
      }

      .btn-capture:hover {
        background: #2c5282;
      }

      #output {
        margin-top: 2rem;
        padding: 1.25rem;
        background: #f8fafc;
        color: #1a365d;
        border-radius: 4px;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        max-height: 600px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
        border: 1px solid #e2e8f0;
      }

      #output:empty::before {
        content: 'Click "Capture Bug Report" to see captured data...';
        color: #718096;
        font-style: italic;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.625rem;
        background: #edf2f7;
        color: #2d3748;
        border-radius: 3px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        border: 1px solid #e2e8f0;
      }

      .test-element {
        padding: 1rem;
        background: white;
        border: 2px dashed #cbd5e0;
        border-radius: 4px;
        margin-top: 1rem;
        text-align: center;
        color: #718096;
      }

      @keyframes fade {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.9;
        }
      }

      .loading {
        animation: fade 1s ease-in-out infinite;
      }

      /* Scrollbar styling */
      #output::-webkit-scrollbar {
        width: 8px;
      }

      #output::-webkit-scrollbar-track {
        background: #1a202c;
        border-radius: 4px;
      }

      #output::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
      }

      #output::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>BugSpotter SDK Demo</h1>
        <p>Test capture features: Screenshots, Console Data, Network Activity & System Information</p>
      </div>

      <div class="content">
        <!-- Console Logging Section -->
        <div class="section">
          <h2>Console Data <span class="badge">Test Console Capture</span></h2>
          <p>Generate console entries to test logging capture functionality.</p>
          <div class="button-grid">
            <button class="btn-info" onclick="testConsoleLog()">console.log</button>
            <button class="btn-warning" onclick="testConsoleWarn()">console.warn</button>
            <button class="btn-danger" onclick="testConsoleError()">console.error</button>
            <button class="btn-success" onclick="testConsoleInfo()">console.info</button>
          </div>
        </div>

        <!-- Network Requests Section -->
        <div class="section">
          <h2>Network Activity <span class="badge">Test Network Capture</span></h2>
          <p>Test network request capture with various API endpoints.</p>
          <div class="button-grid">
            <button class="btn-success" onclick="testSuccessfulRequest()">
              Successful API Call
            </button>
            <button class="btn-danger" onclick="testFailedRequest()">Failed API Call</button>
            <button class="btn-info" onclick="testMultipleRequests()">Multiple Requests</button>
            <button class="btn-warning" onclick="testXHRRequest()">XHR Request</button>
          </div>
        </div>

        <!-- Screenshot Section -->
        <div class="section">
          <h2>Visual Capture <span class="badge">Auto-captured</span></h2>
          <p>Screen content is automatically captured when generating a report.</p>
          <div class="test-element" id="screenshot-test">
            <strong>🎨 This content will be captured in the screenshot!</strong>
            <p>ID: screenshot-test-element-${Date.now()}</p>
          </div>
        </div>

        <!-- Metadata Section -->
        <div class="section">
          <h2>System Information <span class="badge">Auto-captured</span></h2>
          <p>Environment details including browser, viewport, operating system, and timestamps are automatically collected.</p>
          <div class="button-grid">
            <button class="btn-info" onclick="showCurrentMetadata()">Show Current Metadata</button>
          </div>
        </div>

        <!-- Floating Button Widget Section -->
        <div class="section">
          <h2>🎈 Floating Button Widget <span class="badge">New!</span></h2>
          <p>
            The floating bug button appears in the bottom-right corner. Click it to capture a bug
            report! You can also test the widget configuration options below.
          </p>
          <div class="button-grid">
            <button class="btn-info" onclick="showFloatingButton()">Show Button</button>
            <button class="btn-warning" onclick="hideFloatingButton()">Hide Button</button>
            <button class="btn-success" onclick="changeButtonIcon()">Change Icon</button>
            <button class="btn-danger" onclick="changeButtonColor()">Change Color</button>
          </div>
        </div>

        <!-- Bug Report Modal Demo Section -->
        <div class="section">
          <h2>🪟 Bug Report Modal <span class="badge">UI Demo</span></h2>
          <p>
            Click below to open the Bug Report Modal directly, with a sample screenshot preview. Submitting the form will display the bug data below.
          </p>
          <div class="button-grid">
            <button class="btn-primary" onclick="showBugReportModalDemo()">Show Bug Report Modal</button>
          </div>
        </div>

        <!-- Main Capture Button -->
        <div class="section">
          <h2>Generate Report</h2>
          <p>
            Use the floating capture button (bottom-right) or the button below to collect all data:
            console entries, network activity, visual capture, and system information.
          </p>
          <div class="button-grid">
            <button class="btn-capture" onclick="captureBugReport()">Generate Report</button>
          </div>
        </div>

        <!-- Output Section -->
        <div id="output"></div>
      </div>
    </div>

    <script src="../../packages/sdk/dist/bugspotter.min.js"></script>
    <script>
      // Modal demo handler
      async function showBugReportModalDemo() {
        try {
          // Capture real data instead of using placeholder
          const report = await bugSpotter.capture();
          
          const modal = new BugSpotter.BugReportModal({
            onSubmit: async (data) => {
              console.log('🚀 Submitting bug report to API (from modal demo)...');
              
              try {
                // Submit to API
                const payload = {
                  title: data.title,
                  description: data.description,
                  report: report
                };
                
                const response = await fetch(bugSpotter.getConfig().endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${bugSpotter.getConfig().apiKey}`
                  },
                  body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                  throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Bug report submitted successfully:', result);
                
                document.getElementById('output').textContent =
                  '✅ Bug Report Submitted Successfully!\n' + 
                  JSON.stringify({
                    bugId: result.bugId,
                    title: data.title,
                    description: data.description,
                    timestamp: result.timestamp
                  }, null, 2);
              } catch (error) {
                console.error('❌ Failed to submit bug report:', error);
                throw error;
              }
            },
          });
          
          modal.show(report.screenshot);
        } catch (error) {
          console.error('Failed to show modal:', error);
        }
      }

      // Initialize BugSpotter
      const bugSpotter = BugSpotter.BugSpotter.init({
        apiKey: 'demo-api-key-12345',
        endpoint: 'http://localhost:4000/api/bugs',
        showWidget: false, // Disable auto-widget, we'll create our own
      });

      console.log('✅ BugSpotter SDK initialized successfully');

      // Initialize Floating Button Widget
      const floatingButton = new BugSpotter.FloatingButton({
        position: 'bottom-right',
        icon: '⚡',
        backgroundColor: '#1a365d',
        size: 48,
        offset: { x: 24, y: 24 },
        style: {
          boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
          border: '1px solid rgba(255, 255, 255, 0.1)',
          transition: 'all 0.2s ease',
        }
      });

      // Add click handler to floating button
      floatingButton.onClick(async () => {
        console.log('Floating button clicked - capturing data...');
        
        try {
          // Capture all the data
          const report = await bugSpotter.capture();
          
          // Show the modal with the captured screenshot
          const modal = new BugSpotter.BugReportModal({
            onSubmit: async (data) => {
              console.log('🚀 Submitting bug report to API...');
              
              try {
                // Submit to API using the SDK's method
                const payload = {
                  title: data.title,
                  description: data.description,
                  report: report
                };
                
                const response = await fetch(bugSpotter.getConfig().endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${bugSpotter.getConfig().apiKey}`
                  },
                  body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                  throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Bug report submitted successfully:', result);
                
                // Display success message
                document.getElementById('output').textContent = 
                  '✅ Bug Report Submitted Successfully!\n' + 
                  JSON.stringify({
                    bugId: result.bugId,
                    title: data.title,
                    description: data.description,
                    timestamp: result.timestamp,
                    consoleLogs: report.console.length,
                    networkRequests: report.network.length
                  }, null, 2);
              } catch (error) {
                console.error('❌ Failed to submit bug report:', error);
                throw error; // Re-throw to let modal handle it
              }
            },
          });
          
          modal.show(report.screenshot);
        } catch (error) {
          console.error('Failed to capture bug report:', error);
        }
      });

      console.log('✅ Floating button widget initialized');

      // Make an initial API call on page load
      fetch('https://jsonplaceholder.typicode.com/posts/1')
        .then((res) => res.json())
        .then((data) => console.log('📡 Initial API call successful:', data.title))
        .catch((err) => console.error('❌ Initial API call failed:', err));

      // Console Logging Tests
      function testConsoleLog() {
        console.log('🔵 This is a LOG message with data:', {
          timestamp: Date.now(),
          user: 'demo-user',
          action: 'button-click',
        });
      }

      function testConsoleWarn() {
        console.warn('⚠️ This is a WARNING message:', 'Something might be wrong!');
      }

      function testConsoleError() {
        console.error('🔴 This is an ERROR message:', new Error('Something went wrong!'));
      }

      function testConsoleInfo() {
        console.info('ℹ️ This is an INFO message:', 'Informational data', [1, 2, 3]);
      }

      // Network Request Tests
      function testSuccessfulRequest() {
        console.log('🌐 Making successful API request...');
        fetch('https://jsonplaceholder.typicode.com/posts/1')
          .then((res) => res.json())
          .then((data) => console.log('✅ Successful request:', data.title))
          .catch((err) => console.error('❌ Request failed:', err));
      }

      function testFailedRequest() {
        console.log('🌐 Making failed API request...');
        fetch('https://jsonplaceholder.typicode.com/invalid-endpoint-404')
          .then((res) => {
            if (!res.ok) {
              console.error('❌ Request failed with status:', res.status);
            }
            return res.json();
          })
          .catch((err) => console.error('❌ Network error:', err));
      }

      function testMultipleRequests() {
        console.log('🌐 Making multiple API requests...');
        const requests = [1, 2, 3].map((id) =>
          fetch(`https://jsonplaceholder.typicode.com/posts/${id}`)
            .then((res) => res.json())
            .then((data) => console.log(`✅ Request ${id} complete:`, data.title))
        );

        Promise.all(requests)
          .then(() => console.log('✅ All requests completed'))
          .catch((err) => console.error('❌ Some requests failed:', err));
      }

      function testXHRRequest() {
        console.log('🌐 Making XMLHttpRequest...');
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://jsonplaceholder.typicode.com/posts/5');
        xhr.onload = function () {
          if (xhr.status === 200) {
            console.log('✅ XHR request successful');
          }
        };
        xhr.onerror = function () {
          console.error('❌ XHR request failed');
        };
        xhr.send();
      }

      // Metadata Display
      function showCurrentMetadata() {
        const metadata = {
          userAgent: navigator.userAgent,
          viewport: {
            width: window.innerWidth,
            height: window.innerHeight,
          },
          url: window.location.href,
          timestamp: new Date().toISOString(),
          screen: {
            width: window.screen.width,
            height: window.screen.height,
            pixelRatio: window.devicePixelRatio,
          },
        };

        console.log('📊 Current Browser Metadata:', metadata);
        alert('Check the console for current metadata!');
      }

      // Floating Button Widget Controls
      function showFloatingButton() {
        floatingButton.show();
        console.log('👁️ Floating button shown');
      }

      function hideFloatingButton() {
        floatingButton.hide();
        console.log('🙈 Floating button hidden');
      }

      function changeButtonIcon() {
        const icons = ['⚡', '◆', '●', '■', '▲', '◈'];
        const randomIcon = icons[Math.floor(Math.random() * icons.length)];
        floatingButton.setIcon(randomIcon);
        console.log(`Icon changed to: ${randomIcon}`);
      }

      function changeButtonColor() {
        const colors = ['#1a365d', '#2c5282', '#2b6cb0', '#2a4365', '#1e3a8a', '#1e40af'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        floatingButton.setBackgroundColor(randomColor);
        console.log(`Color updated to: ${randomColor}`);
      }

      // Main Capture Function
      async function captureBugReport() {
        const btn = event?.target;
        const originalText = btn?.textContent;
        
        if (btn) {
          btn.textContent = '⏳ Capturing...';
          btn.classList.add('loading');
          btn.disabled = true;
        }

        console.log('🐛 Starting bug report capture...');

        try {
          // Add a small delay to ensure all console logs are captured
          await new Promise((resolve) => setTimeout(resolve, 100));

          const data = await bugSpotter.capture();

          console.log('✅ Bug report captured successfully!');

          // Format the output nicely
          const formattedData = {
            '🕐 Captured At': new Date(data.metadata.timestamp).toLocaleString(),
            '🌍 URL': data.metadata.url,
            '🖥️ Browser': data.metadata.browser,
            '💻 OS': data.metadata.os,
            '📐 Viewport': `${data.metadata.viewport.width}x${data.metadata.viewport.height}`,
            '📝 Console Logs': `${data.console.length} entries`,
            '🌐 Network Requests': `${data.network.length} requests`,
            '📸 Screenshot': data.screenshot === 'SCREENSHOT_FAILED' ? '❌ Failed' : '✅ Captured',
            '📦 Full Data': data,
          };

          document.getElementById('output').textContent = JSON.stringify(formattedData, null, 2);
        } catch (error) {
          console.error('❌ Failed to capture bug report:', error);
          document.getElementById('output').textContent =
            '❌ Error capturing bug report:\n' + error.message;
        } finally {
          if (btn) {
            btn.textContent = originalText;
            btn.classList.remove('loading');
            btn.disabled = false;
          }
        }
      }

      // Add some test data on page load
      console.log('🎬 Demo page loaded successfully!');
      console.info('💡 Try clicking different buttons to test capture functionality');
    </script>
  </body>
</html>
