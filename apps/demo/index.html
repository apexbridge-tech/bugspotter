<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BugSpotter Demo - Test All Capture Features</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css" crossorigin="anonymous" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        padding: 2rem;
        background: #f5f7fa;
        min-height: 100vh;
        color: #1a202c;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #1a365d;
        color: white;
        padding: 2rem;
        border-bottom: 1px solid #2c5282;
      }

      .header h1 {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .header p {
        font-size: 1rem;
        color: #e2e8f0;
        font-weight: 400;
      }

      .content {
        padding: 2rem;
      }

      .section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f7fafc;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
      }

      .section h2 {
        color: #2d3748;
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .section p {
        color: #4a5568;
        margin-bottom: 1rem;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .button-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
      }

      button {
        padding: 0.625rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      button:hover {
        opacity: 0.95;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      button:active {
        opacity: 1;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #2c5282;
        color: white;
      }

      .btn-primary:hover {
        background: #2a4365;
      }

      .btn-success {
        background: #2f855a;
        color: white;
      }

      .btn-success:hover {
        background: #276749;
      }

      .btn-warning {
        background: #c05621;
        color: white;
      }

      .btn-warning:hover {
        background: #9c4221;
      }

      .btn-danger {
        background: #c53030;
        color: white;
      }

      .btn-danger:hover {
        background: #9b2c2c;
      }

      .btn-info {
        background: #2b6cb0;
        color: white;
      }

      .btn-info:hover {
        background: #2c5282;
      }

      .btn-capture {
        grid-column: 1 / -1;
        background: #1a365d;
        color: white;
        font-size: 1rem;
        padding: 1rem;
        font-weight: 500;
        letter-spacing: 0.025em;
      }

      .btn-capture:hover {
        background: #2c5282;
      }

      #output {
        margin-top: 2rem;
        padding: 1.25rem;
        background: #f8fafc;
        color: #1a365d;
        border-radius: 4px;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        max-height: 600px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-word;
        border: 1px solid #e2e8f0;
      }

      #output:empty::before {
        content: 'Click "Capture Bug Report" to see captured data...';
        color: #718096;
        font-style: italic;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.625rem;
        background: #edf2f7;
        color: #2d3748;
        border-radius: 3px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        border: 1px solid #e2e8f0;
      }

      .test-element {
        padding: 1rem;
        background: white;
        border: 2px dashed #cbd5e0;
        border-radius: 4px;
        margin-top: 1rem;
        text-align: center;
        color: #718096;
      }

      @keyframes fade {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.9;
        }
      }

      .loading {
        animation: fade 1s ease-in-out infinite;
      }

      /* Scrollbar styling */
      #output::-webkit-scrollbar {
        width: 8px;
      }

      #output::-webkit-scrollbar-track {
        background: #1a202c;
        border-radius: 4px;
      }

      #output::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
      }

      #output::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }

      /* Replay Player Styles */
      #replay-player-container {
        display: none;
        margin-top: 1rem;
        padding: 1.5rem;
        background: white;
        border: 2px solid #3182ce;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #replay-player-container.active {
        display: block;
      }

      .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
      }

      .player-header h3 {
        font-size: 1.1rem;
        color: #2d3748;
        font-weight: 600;
      }

      .player-stats {
        font-size: 0.85rem;
        color: #718096;
      }

      .player-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      #replay-player {
        width: 100%;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>BugSpotter SDK Demo</h1>
        <p>Test capture features: Screenshots, Console Data, Network Activity, Session Replay & System Information</p>
      </div>

      <div class="content">
        <!-- Console Logging Section -->
        <div class="section">
          <h2>Console Data <span class="badge">Test Console Capture</span></h2>
          <p>Generate console entries to test logging capture functionality.</p>
          <div class="button-grid">
            <button class="btn-info" onclick="testConsoleLog()">console.log</button>
            <button class="btn-warning" onclick="testConsoleWarn()">console.warn</button>
            <button class="btn-danger" onclick="testConsoleError()">console.error</button>
            <button class="btn-success" onclick="testConsoleInfo()">console.info</button>
          </div>
        </div>

        <!-- Network Requests Section -->
        <div class="section">
          <h2>Network Activity <span class="badge">Test Network Capture</span></h2>
          <p>Test network request capture with various API endpoints.</p>
          <div class="button-grid">
            <button class="btn-success" onclick="testSuccessfulRequest()">
              Successful API Call
            </button>
            <button class="btn-danger" onclick="testFailedRequest()">Failed API Call</button>
            <button class="btn-info" onclick="testMultipleRequests()">Multiple Requests</button>
            <button class="btn-warning" onclick="testXHRRequest()">XHR Request</button>
          </div>
        </div>

        <!-- Screenshot Section -->
        <div class="section">
          <h2>Visual Capture <span class="badge">Auto-captured</span></h2>
          <p>Screen content is automatically captured when generating a report.</p>
          <div class="test-element" id="screenshot-test">
            <strong>🎨 This content will be captured in the screenshot!</strong>
            <p>ID: screenshot-test-element-${Date.now()}</p>
          </div>
        </div>

        <!-- PII Sanitization Section -->
        <div class="section">
          <h2>🔒 Data Sanitization <span class="badge">Privacy & Security</span></h2>
          <p>Test automatic detection and sanitization of PII (Personally Identifiable Information) and sensitive credentials.</p>
          <div class="test-element" id="pii-test-area" style="text-align: left; font-family: monospace; font-size: 0.9rem; line-height: 1.6;">
            <strong>Sample Sensitive Data:</strong><br>
            <em style="color: #718096;">PII (Personal Info):</em><br>
            Email: john.doe@example.com<br>
            Phone: (555) 123-4567<br>
            Credit Card: 4532-1234-5678-9010<br>
            SSN: 123-45-6789<br>
            <br>
            <em style="color: #718096;">Credentials (Secrets):</em><br>
            API Key: sk_live_abc123def456ghi789<br>
            Token: ghp_1234567890abcdefghijklmnopqrstuv<br>
            Password: MySecureP@ss123<br>
          </div>
          <div class="button-grid">
            <button class="btn-primary" onclick="testPIISanitization()">Test Data Sanitization</button>
            <button class="btn-info" onclick="testPIIInConsole()">Log Sensitive Data</button>
            <button class="btn-success" onclick="showSanitizedData()">Show Before/After</button>
          </div>
          <div id="pii-output" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border: 1px solid #48bb78; border-radius: 4px; font-size: 0.9rem; font-family: monospace;"></div>
        </div>

        <!-- Metadata Section -->
        <div class="section">
          <h2>System Information <span class="badge">Auto-captured</span></h2>
          <p>Environment details including browser, viewport, operating system, and timestamps are automatically collected.</p>
          <div class="button-grid">
            <button class="btn-info" onclick="showCurrentMetadata()">Show Current Metadata</button>
          </div>
        </div>

        <!-- Session Replay Section -->
        <div class="section">
          <h2>🎥 Session Replay <span class="badge">New!</span></h2>
          <p>
            Your interactions are continuously recorded in a 30-second circular buffer. DOM changes, clicks, scrolls, and mouse movements are captured automatically. Play back your session below!
          </p>
          <div class="button-grid">
            <button class="btn-primary" onclick="playReplay()">▶️ Play Session Replay</button>
            <button class="btn-info" onclick="showReplayInfo()">Show Replay Info</button>
            <button class="btn-success" onclick="testInteraction()">Test Interaction</button>
            <button class="btn-warning" onclick="stopReplay()">⏹️ Stop Replay</button>
          </div>
          <div id="replay-info" style="display: none; margin-top: 1rem; padding: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.9rem;"></div>
          
          <!-- Replay Player -->
          <div id="replay-player-container">
            <div class="player-header">
              <h3>📹 Session Replay Player</h3>
              <div class="player-stats" id="player-stats">Ready to play</div>
            </div>
            <div id="replay-player"></div>
            <div class="player-controls">
              <button class="btn-success" onclick="replayPlayer && replayPlayer.play()">▶️ Play</button>
              <button class="btn-warning" onclick="replayPlayer && replayPlayer.pause()">⏸️ Pause</button>
              <button class="btn-info" onclick="replayPlayer && replayPlayer.setSpeed(2)">2x Speed</button>
              <button class="btn-info" onclick="replayPlayer && replayPlayer.setSpeed(1)">1x Speed</button>
              <button class="btn-danger" onclick="stopReplay()">⏹️ Close</button>
            </div>
          </div>
        </div>

        <!-- Floating Button Widget Section -->
        <div class="section">
          <h2>🎈 Floating Button Widget <span class="badge">Updated!</span></h2>
          <p>
            The floating bug button appears in the bottom-right corner. Click it to capture a bug
            report! You can also test the widget configuration options below.
          </p>
          <div class="button-grid">
            <button class="btn-info" onclick="showFloatingButton()">Show Button</button>
            <button class="btn-warning" onclick="hideFloatingButton()">Hide Button</button>
            <button class="btn-success" onclick="changeButtonIcon()">Change Icon</button>
            <button class="btn-danger" onclick="changeButtonColor()">Change Color</button>
          </div>
        </div>

        <!-- Bug Report Modal Demo Section -->
        <div class="section">
          <h2>🪟 Bug Report Modal <span class="badge">UI Demo</span></h2>
          <p>
            Click below to open the Bug Report Modal directly, with a sample screenshot preview. Submitting the form will display the bug data below.
          </p>
          <div class="button-grid">
            <button class="btn-primary" onclick="showBugReportModalDemo()">Show Bug Report Modal</button>
          </div>
        </div>

        <!-- Main Capture Button -->
        <div class="section">
          <h2>Generate Report</h2>
          <p>
            Use the floating capture button (bottom-right) or the button below to collect all data:
            console entries, network activity, visual capture, and system information.
          </p>
          <div class="button-grid">
            <button class="btn-capture" onclick="captureBugReport()">Generate Report</button>
          </div>
        </div>

        <!-- Output Section -->
        <div id="output"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>
    <script src="bugspotter.min.js"></script>
    <script>
      // Initialize BugSpotter SDK first (before any functions that use it)
      const bugSpotter = BugSpotter.BugSpotter.init({
        apiKey: 'demo-api-key-12345',
        endpoint: 'http://localhost:4000/api/bugs',
        showWidget: false, // Disable auto-widget, we'll create our own
        replay: {
          enabled: true,
          duration: 30,  // Keep last 30 seconds
          sampling: {
            mousemove: 50,
            scroll: 100,
          }
        }
      });

      console.log('✅ BugSpotter SDK initialized successfully');

      // Global replay player instance
      let replayPlayer = null;
      
      // Modal demo handler
      async function showBugReportModalDemo() {
        try {
          // Capture real data instead of using placeholder
          const report = await bugSpotter.capture();
          
          const modal = new BugSpotter.BugReportModal({
            onSubmit: async (data) => {
              console.log('🚀 Submitting bug report to API (from modal demo)...');
              
              try {
                // Submit to API
                const payload = {
                  title: data.title,
                  description: data.description,
                  report: report
                };
                
                const response = await fetch(bugSpotter.getConfig().endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${bugSpotter.getConfig().apiKey}`
                  },
                  body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                  throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Bug report submitted successfully:', result);
                
                document.getElementById('output').textContent =
                  '✅ Bug Report Submitted Successfully!\n' + 
                  JSON.stringify({
                    bugId: result.bugId,
                    title: data.title,
                    description: data.description,
                    timestamp: result.timestamp,
                    replayEvents: report.replay.length
                  }, null, 2);
              } catch (error) {
                console.error('❌ Failed to submit bug report:', error);
                throw error;
              }
            },
          });
          
          modal.show(report.screenshot);
        } catch (error) {
          console.error('Failed to show modal:', error);
        }
      }

      // Initialize BugSpotter
      // Initialize Floating Button Widget (bugSpotter already initialized at top)
      const floatingButton = new BugSpotter.FloatingButton({
        position: 'bottom-right',
        icon: '⚡',
        backgroundColor: '#1a365d',
        size: 48,
        offset: { x: 24, y: 24 },
        style: {
          boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
          border: '1px solid rgba(255, 255, 255, 0.1)',
          transition: 'all 0.2s ease',
        }
      });

      // Add click handler to floating button
      floatingButton.onClick(async () => {
        console.log('Floating button clicked - capturing data...');
        
        try {
          // Capture all the data
          const report = await bugSpotter.capture();
          
          // Show the modal with the captured screenshot
          const modal = new BugSpotter.BugReportModal({
            onSubmit: async (data) => {
              console.log('🚀 Submitting bug report to API...');
              
              try {
                // Submit to API using the SDK's method
                const payload = {
                  title: data.title,
                  description: data.description,
                  report: report
                };
                
                const response = await fetch(bugSpotter.getConfig().endpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${bugSpotter.getConfig().apiKey}`
                  },
                  body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                  throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Bug report submitted successfully:', result);
                
                // Display success message
                document.getElementById('output').textContent = 
                  '✅ Bug Report Submitted Successfully!\n' + 
                  JSON.stringify({
                    bugId: result.bugId,
                    title: data.title,
                    description: data.description,
                    timestamp: result.timestamp,
                    consoleLogs: report.console.length,
                    networkRequests: report.network.length,
                    replayEvents: report.replay.length
                  }, null, 2);
              } catch (error) {
                console.error('❌ Failed to submit bug report:', error);
                throw error; // Re-throw to let modal handle it
              }
            },
          });
          
          modal.show(report.screenshot);
        } catch (error) {
          console.error('Failed to capture bug report:', error);
        }
      });

      console.log('✅ Floating button widget initialized');

      // Make an initial API call on page load
      fetch('https://jsonplaceholder.typicode.com/posts/1')
        .then((res) => res.json())
        .then((data) => console.log('📡 Initial API call successful:', data.title))
        .catch((err) => console.error('❌ Initial API call failed:', err));

      // Console Logging Tests
      function testConsoleLog() {
        console.log('🔵 This is a LOG message with data:', {
          timestamp: Date.now(),
          user: 'demo-user',
          action: 'button-click',
        });
      }

      function testConsoleWarn() {
        console.warn('⚠️ This is a WARNING message:', 'Something might be wrong!');
      }

      function testConsoleError() {
        console.error('🔴 This is an ERROR message:', new Error('Something went wrong!'));
      }

      function testConsoleInfo() {
        console.info('ℹ️ This is an INFO message:', 'Informational data', [1, 2, 3]);
      }

      // Network Request Tests
      function testSuccessfulRequest() {
        console.log('🌐 Making successful API request...');
        fetch('https://jsonplaceholder.typicode.com/posts/1')
          .then((res) => res.json())
          .then((data) => console.log('✅ Successful request:', data.title))
          .catch((err) => console.error('❌ Request failed:', err));
      }

      function testFailedRequest() {
        console.log('🌐 Making failed API request...');
        fetch('https://jsonplaceholder.typicode.com/invalid-endpoint-404')
          .then((res) => {
            if (!res.ok) {
              console.error('❌ Request failed with status:', res.status);
            }
            return res.json();
          })
          .catch((err) => console.error('❌ Network error:', err));
      }

      function testMultipleRequests() {
        console.log('🌐 Making multiple API requests...');
        const requests = [1, 2, 3].map((id) =>
          fetch(`https://jsonplaceholder.typicode.com/posts/${id}`)
            .then((res) => res.json())
            .then((data) => console.log(`✅ Request ${id} complete:`, data.title))
        );

        Promise.all(requests)
          .then(() => console.log('✅ All requests completed'))
          .catch((err) => console.error('❌ Some requests failed:', err));
      }

      function testXHRRequest() {
        console.log('🌐 Making XMLHttpRequest...');
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://jsonplaceholder.typicode.com/posts/5');
        xhr.onload = function () {
          if (xhr.status === 200) {
            console.log('✅ XHR request successful');
          }
        };
        xhr.onerror = function () {
          console.error('❌ XHR request failed');
        };
        xhr.send();
      }

      // PII and Credentials Sanitization Tests
      function testPIISanitization() {
        console.log('🔒 Testing PII and credential detection/sanitization...');
        
        const testData = {
          // PII (Personally Identifiable Information)
          email: 'john.doe@example.com',
          phone: '(555) 123-4567',
          creditCard: '4532-1234-5678-9010',
          ssn: '123-45-6789',
          ipAddress: '192.168.1.100',
          
          // Credentials (Secrets - NOT PII, but still sensitive)
          apiKey: 'sk_live_abc123def456ghi789',
          token: 'ghp_1234567890abcdefghijklmnopqrstuv',
          password: 'MySecureP@ss123',
          
          // Normal data
          normalData: 'This is normal data without PII or secrets'
        };
        
        // Use the SDK's sanitization utility
        const sanitized = BugSpotter.sanitize(JSON.stringify(testData, null, 2));
        
        document.getElementById('pii-output').style.display = 'block';
        document.getElementById('pii-output').innerHTML = `
          <strong>✅ Data Sanitization Test Complete</strong><br><br>
          <strong>Original Data (PII + Credentials):</strong><br>
          <pre style="background: #fff5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto;">${JSON.stringify(testData, null, 2)}</pre>
          <br>
          <strong>Sanitized Data (Protected):</strong><br>
          <pre style="background: #f0fff4; padding: 0.5rem; border-radius: 4px; overflow-x: auto;">${sanitized}</pre>
          <br>
          <em style="color: #38a169;">✓ PII: email, phone, credit card, SSN, IP</em><br>
          <em style="color: #3182ce;">✓ Credentials: API keys, tokens, passwords</em>
        `;
        
        console.log('Original data:', testData);
        console.log('Sanitized data:', sanitized);
      }

      function testPIIInConsole() {
        console.log('=== Testing PII Detection ===');
        console.log('📧 User email: support@example.com');
        console.log('📞 Contact phone: +1 (555) 987-6543');
        console.log('💳 Payment method: 5555-5555-5555-4444');
        console.log('🆔 SSN: 987-65-4321');
        console.log('');
        console.log('=== Testing Credential Detection ===');
        console.log('🔑 API Key: sk_test_FAKE_KEY_FOR_DEMO_ONLY');
        console.log('🎫 GitHub Token: ghp_FAKE_TOKEN_FOR_DEMO');
        console.log('🔐 Password: MyP@ssw0rd123!');
        console.warn('⚠️ All sensitive data is automatically sanitized when captured!');
        console.info('ℹ️ Check the Console Data section below to see sanitized logs');
      }

      function showSanitizedData() {
        const sampleText = `
User Profile & Access Information:
========================================
PERSONAL INFORMATION (PII):
- Email: alice.smith@company.com
- Phone: 555-123-4567
- Mobile: +1-555-987-6543
- Credit Card: 4111111111111111
- SSN: 456-78-9012
- IP Address: 10.0.1.45

CREDENTIALS (SECRETS - NOT PII):
- API Key: sk_live_FAKE_DEMO_KEY_NOT_REAL
- Access Token: ghp_FAKE_DEMO_TOKEN_NOT_REAL
- Password: MySecure123!Pass

SAFE DATA:
- Customer ID: #12345
- Order Number: ORD-2024-5678
        `.trim();
        
        const sanitized = BugSpotter.sanitize(sampleText);
        
        document.getElementById('pii-output').style.display = 'block';
        document.getElementById('pii-output').innerHTML = `
          <strong>✅ Text Sanitization Demo</strong><br><br>
          <strong>Before Sanitization:</strong><br>
          <div style="background: #fff5f5; padding: 0.5rem; border-radius: 4px; white-space: pre-wrap; margin-bottom: 1rem;">${sampleText}</div>
          <strong>After Sanitization:</strong><br>
          <div style="background: #f0fff4; padding: 0.5rem; border-radius: 4px; white-space: pre-wrap;">${sanitized}</div>
          <br>
          <em style="color: #38a169;">✓ PII redacted: email, phone, credit card, SSN, IP address</em><br>
          <em style="color: #3182ce;">✓ Credentials redacted: API keys, tokens, passwords</em><br>
          <em style="color: #718096;">✓ Safe data preserved: customer ID, order number</em>
        `;
        
        console.log('Sanitization complete - check output above');
      }

      // Metadata Display
      function showCurrentMetadata() {
        const metadata = {
          userAgent: navigator.userAgent,
          viewport: {
            width: window.innerWidth,
            height: window.innerHeight,
          },
          url: window.location.href,
          timestamp: new Date().toISOString(),
          screen: {
            width: window.screen.width,
            height: window.screen.height,
            pixelRatio: window.devicePixelRatio,
          },
        };

        console.log('📊 Current Browser Metadata:', metadata);
        alert('Check the console for current metadata!');
      }

      // Floating Button Widget Controls
      function showFloatingButton() {
        floatingButton.show();
        console.log('👁️ Floating button shown');
      }

      function hideFloatingButton() {
        floatingButton.hide();
        console.log('🙈 Floating button hidden');
      }

      function changeButtonIcon() {
        const icons = ['⚡', '◆', '●', '■', '▲', '◈'];
        const randomIcon = icons[Math.floor(Math.random() * icons.length)];
        floatingButton.setIcon(randomIcon);
        console.log(`Icon changed to: ${randomIcon}`);
      }

      function changeButtonColor() {
        const colors = ['#1a365d', '#2c5282', '#2b6cb0', '#2a4365', '#1e3a8a', '#1e40af'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        floatingButton.setBackgroundColor(randomColor);
        console.log(`Color updated to: ${randomColor}`);
      }

      // Main Capture Function
      async function captureBugReport() {
        const btn = event?.target;
        const originalText = btn?.textContent;
        
        if (btn) {
          btn.textContent = '⏳ Capturing...';
          btn.classList.add('loading');
          btn.disabled = true;
        }

        console.log('🐛 Starting bug report capture...');

        try {
          // Add a small delay to ensure all console logs are captured
          await new Promise((resolve) => setTimeout(resolve, 100));

          const data = await bugSpotter.capture();

          console.log('✅ Bug report captured successfully!');

          // Format the output nicely
          const formattedData = {
            '🕐 Captured At': new Date(data.metadata.timestamp).toLocaleString(),
            '🌍 URL': data.metadata.url,
            '🖥️ Browser': data.metadata.browser,
            '💻 OS': data.metadata.os,
            '📐 Viewport': `${data.metadata.viewport.width}x${data.metadata.viewport.height}`,
            '📝 Console Logs': `${data.console.length} entries`,
            '🌐 Network Requests': `${data.network.length} requests`,
            '🎥 Replay Events': `${data.replay.length} events (${data.replay.length > 0 ? ((data.replay[data.replay.length - 1].timestamp - data.replay[0].timestamp) / 1000).toFixed(1) + 's' : '0s'})`,
            '📸 Screenshot': data.screenshot === 'SCREENSHOT_FAILED' ? '❌ Failed' : '✅ Captured',
            '📦 Full Data': data,
          };

          document.getElementById('output').textContent = JSON.stringify(formattedData, null, 2);
        } catch (error) {
          console.error('❌ Failed to capture bug report:', error);
          document.getElementById('output').textContent =
            '❌ Error capturing bug report:\n' + error.message;
        } finally {
          if (btn) {
            btn.textContent = originalText;
            btn.classList.remove('loading');
            btn.disabled = false;
          }
        }
      }

      // Session Replay Functions
      function playReplay() {
        const events = bugSpotter.domCollector.getEvents();
        
        if (events.length === 0) {
          alert('No replay events captured yet. Interact with the page first!');
          return;
        }

        // Show player container
        const container = document.getElementById('replay-player-container');
        container.classList.add('active');

        // Update stats
        const timeSpan = ((events[events.length - 1].timestamp - events[0].timestamp) / 1000).toFixed(2);
        document.getElementById('player-stats').textContent = 
          `${events.length} events • ${timeSpan}s duration`;

        // Destroy existing player if any
        if (replayPlayer) {
          replayPlayer.pause();
          document.getElementById('replay-player').innerHTML = '';
        }

        // Create new player
        try {
          // Log first few events to debug
          console.log('First 5 events:', events.slice(0, 5));
          
          // Check if we have a fullSnapshot event (type 2)
          const hasSnapshot = events.some(e => e.type === 2);
          if (!hasSnapshot) {
            console.warn('⚠️ No full snapshot found in events. Replay may not display correctly.');
          }
          
          replayPlayer = new rrwebPlayer({
            target: document.getElementById('replay-player'),
            props: {
              events: events,
              autoPlay: true,
              speedOption: [1, 2, 4, 8],
              showController: true,
              skipInactive: false,
              mouseTail: {
                duration: 500,
                strokeStyle: '#3182ce',
              },
            },
          });
          
          console.log('🎬 Replay player started with', events.length, 'events');
          console.log('Event types:', [...new Set(events.map(e => e.type))]);
        } catch (error) {
          console.error('Failed to create replay player:', error);
          alert('Failed to start replay player: ' + error.message);
        }
      }

      function stopReplay() {
        const container = document.getElementById('replay-player-container');
        container.classList.remove('active');
        
        if (replayPlayer) {
          replayPlayer.pause();
        }
        
        console.log('⏹️ Replay player stopped');
      }

      async function showReplayInfo() {
        try {
          const report = await bugSpotter.capture();
          const replayEvents = report.replay;
          
          const infoDiv = document.getElementById('replay-info');
          infoDiv.style.display = 'block';
          
          if (replayEvents.length === 0) {
            infoDiv.innerHTML = '<strong>No replay events captured yet.</strong><br>Interact with the page to generate events!';
            return;
          }
          
          const timeSpan = ((replayEvents[replayEvents.length - 1].timestamp - replayEvents[0].timestamp) / 1000).toFixed(2);
          const eventTypes = [...new Set(replayEvents.map(e => e.type))];
          
          infoDiv.innerHTML = `
            <strong>📊 Replay Buffer Status:</strong><br>
            • Total Events: ${replayEvents.length}<br>
            • Time Span: ${timeSpan} seconds<br>
            • Event Types: ${eventTypes.join(', ')}<br>
            • First Event: ${new Date(replayEvents[0].timestamp).toLocaleTimeString()}<br>
            • Last Event: ${new Date(replayEvents[replayEvents.length - 1].timestamp).toLocaleTimeString()}<br>
            <br>
            <em>These events will be included when you submit a bug report!</em>
          `;
          
          console.log('🎥 Replay Events:', {
            count: replayEvents.length,
            timeSpan: timeSpan + 's',
            types: eventTypes,
            sample: replayEvents.slice(0, 3)
          });
        } catch (error) {
          console.error('Failed to get replay info:', error);
        }
      }
      
      function testInteraction() {
        const testElement = document.getElementById('screenshot-test');
        const colors = ['#e6f2ff', '#ffe6f2', '#f2ffe6', '#fff2e6', '#f2e6ff'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        
        testElement.style.background = randomColor;
        testElement.innerHTML = `
          <strong>🎨 Content Updated!</strong>
          <p>This DOM change was recorded at ${new Date().toLocaleTimeString()}</p>
          <p>Background: ${randomColor}</p>
        `;
        
        console.log('✨ Test interaction triggered - DOM changed!');
        
        // Automatically show replay info after interaction
        setTimeout(() => showReplayInfo(), 500);
      }

      // Add some test data on page load
      console.log('🎬 Demo page loaded successfully!');
      console.info('💡 Try clicking different buttons to test capture functionality');
      console.info('🎥 Session replay is active - all interactions are being recorded!');
    </script>
  </body>
</html>
